name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # Use GitHub Container Registry
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase Repo Name
        run: |
          echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/${{ env.REPO_LOWER }}-backend:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/${{ env.REPO_LOWER }}-frontend:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Lowercase Repo Name
        run: |
          echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Prepare server environment file
        uses: appleboy/ssh-action@v1.0.3
        env:
          EC2_ENV_FILE: ${{ secrets.EC2_ENV_FILE }}
          REPO_LOWER: ${{ env.REPO_LOWER }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: EC2_ENV_FILE,REPO_LOWER
          script: |
            set -euo pipefail

            if [ -z "${EC2_ENV_FILE:-}" ]; then
              echo "EC2_ENV_FILE secret is required."
              exit 1
            fi

            mkdir -p ~/viba-studio
            printf "%s\n" "$EC2_ENV_FILE" > ~/viba-studio/.env
            chmod 600 ~/viba-studio/.env

            if grep -q '^IMAGE_REPO=' ~/viba-studio/.env; then
              sed -i "s|^IMAGE_REPO=.*|IMAGE_REPO=ghcr.io/${REPO_LOWER}|" ~/viba-studio/.env
            else
              echo "IMAGE_REPO=ghcr.io/${REPO_LOWER}" >> ~/viba-studio/.env
            fi

      - name: Copy docker-compose.yml to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml"
          target: "~/viba-studio/"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: GHCR_USERNAME,GHCR_TOKEN
          script: |
            set -euo pipefail

            # Navigate to project dir
            cd ~/viba-studio

            if [ -z "${GHCR_USERNAME:-}" ] || [ -z "${GHCR_TOKEN:-}" ]; then
              echo "GHCR_USERNAME and GHCR_TOKEN secrets are required."
              exit 1
            fi

            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

            APP_SERVICES="backend frontend"

            if docker compose version >/dev/null 2>&1; then
              COMPOSE_CMD="docker compose --env-file .env"
            else
              COMPOSE_CMD="docker-compose --env-file .env"
            fi

            # Deploy stateless app services only; do not recreate db on each release.
            $COMPOSE_CMD pull $APP_SERVICES
            $COMPOSE_CMD up -d --no-deps --remove-orphans $APP_SERVICES

            # First deployment fallback: create db if missing.
            if ! docker ps -a --format '{{.Names}}' | grep -q '^viba_db$'; then
              $COMPOSE_CMD up -d db
            fi

            # Health check backend before reporting deployment success
            for i in $(seq 1 30); do
              if curl -fsS http://localhost:3001/health >/dev/null; then
                echo "Backend health check passed."
                break
              fi
              if [ "$i" -eq 30 ]; then
                echo "Backend health check failed."
                docker logs --tail 200 viba_backend || true
                exit 1
              fi
              sleep 2
            done

            docker image prune -f
